# This workflow will install Python dependencies, run tests, lint with pylint, and report code coverage
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Tests

on: [push]

jobs:
    tests:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.12"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                python-version: ${{ matrix.python-version }}

            - name: Install system dependencies for PySide6
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      libegl1 \
                      libgl1 \
                      libglx-mesa0 \
                      libxkbcommon-x11-0 \
                      libxcb-xinerama0 \
                      libxcb-cursor0 \
                      libxcb-icccm4 \
                      libxcb-image0 \
                      libxcb-keysyms1 \
                      libxcb-randr0 \
                      libxcb-render-util0 \
                      libxcb-xfixes0 \
                      libxcb-xinput0 \
                      libxcb-xkb1 \
                      libglib2.0-0 \
                      libfontconfig1 \
                      libdbus-1-3

            - name: Install Python dependencies
              run: |
                  python -m pip install --upgrade pip setuptools wheel
                  python -m pip install \
                      pytest \
                      pytest-cov \
                      pylint \
                      apache-license-check
                  python -m pip install .

            - name: Run license-check
              run: apache-license-check --copyright "Ben Deda"

            - name: Lint with pylint
              run: |
                  # Run pylint on source code
                  pylint src/deda/ --rcfile=.pylintrc || true
                  # Exit with error if pylint score is below threshold
                  pylint src/deda/ --rcfile=.pylintrc --fail-under=7.0 || true
              continue-on-error: true

            - name: Run pytest with coverage
              env:
                  DISPLAY: :99
                  QT_QPA_PLATFORM: offscreen
              run: |
                  # Set up virtual display for headless PySide6
                  export DISPLAY=:99
                  export QT_QPA_PLATFORM=offscreen
                  # Run tests with coverage
                  pytest tests/ \
                      --cov=src/deda \
                      --cov-report=term-missing \
                      --cov-report=xml \
                      --cov-report=html \
                      --cov-fail-under=0 \
                      -v

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
                  verbose: true

            - name: Coverage summary
              run: |
                  echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
                  echo "Coverage report generated. See details in artifacts." >> $GITHUB_STEP_SUMMARY
                  if [ -f coverage.xml ]; then
                      echo "Coverage XML: ✅" >> $GITHUB_STEP_SUMMARY
                  fi
                  if [ -d htmlcov ]; then
                      echo "HTML Coverage: ✅" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Upload coverage HTML report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report-${{ matrix.python-version }}
                  path: htmlcov/
                  retention-days: 30